## 权限模块开发顺序与逻辑关系

---

### 一、核心依赖链路图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              权限系统数据流向                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   [API 接口]  ──绑定──▶  [Menu 菜单]  ──分配──▶  [Role 角色]  ──授权──▶  [User 用户] │
│      │                      │                      │                     │      │
│      │                      │                      │                     │      │
│      ▼                      ▼                      ▼                     ▼      │
│   /api/xxx               sys_user_list         super_admin           张三@组织A   │
│   GET/POST               sys_role_edit            admin              李四@组织B   │
│                                                   user                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

权限判断链路（反向）：
User ──拥有──▶ Role ──包含──▶ Menu ──关联──▶ API ──能否访问?
```

---

### 二、模块依赖关系

```
                    ┌──────────────────┐
                    │   User 用户模块   │
                    │  (分配角色接口)   │
                    └────────┬─────────┘
                             │ 依赖
                             ▼
                    ┌──────────────────┐
                    │   Role 角色模块   │
                    │  (分配菜单接口)   │
                    └────────┬─────────┘
                             │ 依赖
                             ▼
                    ┌──────────────────┐
                    │   Menu 菜单模块   │
                    │  (绑定API接口)    │
                    └────────┬─────────┘
                             │ 依赖
                             ▼
                    ┌──────────────────┐
                    │   API 接口模块    │
                    │   (无依赖,底层)   │
                    └──────────────────┘
                    
                    ┌──────────────────┐
                    │   Org 组织模块    │  ← 独立模块，与权限链平行
                    │  (多租户上下文)   │
                    └──────────────────┘
```

---

### 三、推荐开发顺序

|  阶段  | 模块 | 接口数 | 依赖说明      | 开发理由                      |
| :----: | ---- | :----: | ------------- | ----------------------------- |
| **P0** | API  |   6    | 无依赖        | 权限链最底层，Menu需要绑定API |
| **P1** | Menu |   7    | 依赖 API      | Role需要分配Menu权限          |
| **P2** | Role |   6    | 依赖 Menu     | User需要分配Role              |
| **P3** | Org  |   6    | 独立          | 多租户上下文，User切换组织    |
| **P4** | User |   4    | 依赖 Role+Org | 补充用户管理功能              |

---

### 四、各模块接口清单

#### P0: API 模块（6 个接口）

| 序号 | 方法   | 路径                   | 功能            |
| :--: | ------ | ---------------------- | --------------- |
|  1   | GET    | `/api/system/api/list` | 获取API列表     |
|  2   | POST   | `/api/system/api`      | 创建API         |
|  3   | GET    | `/api/system/api/{id}` | 获取API详情     |
|  4   | PUT    | `/api/system/api/{id}` | 更新API         |
|  5   | DELETE | `/api/system/api/{id}` | 删除API         |
|  6   | POST   | `/api/system/api/sync` | 同步路由到API表 |

#### P1: Menu 模块（7 个接口）

| 序号 | 方法   | 路径                        | 功能                        |
| :--: | ------ | --------------------------- | --------------------------- |
|  1   | GET    | `/api/system/menu/tree`     | 获取完整菜单树              |
|  2   | GET    | `/api/system/menu/my`       | 获取当前用户路由            |
|  3   | GET    | `/api/system/menu/list`     | 获取菜单列表                |
|  4   | POST   | `/api/system/menu`          | 创建菜单                    |
|  5   | GET    | `/api/system/menu/{id}`     | 获取菜单详情                |
|  6   | PUT    | `/api/system/menu/{id}`     | 更新菜单                    |
|  7   | DELETE | `/api/system/menu/{id}`     | 删除菜单                    |
|  8   | POST   | `/api/system/menu/bind_api` | 绑定API到菜单 ⬅️ 依赖API模块 |

#### P2: Role 模块（6 个接口）

| 序号 | 方法   | 路径                           | 功能                        |
| :--: | ------ | ------------------------------ | --------------------------- |
|  1   | GET    | `/api/system/role/list`        | 获取角色列表                |
|  2   | POST   | `/api/system/role`             | 创建角色                    |
|  3   | PUT    | `/api/system/role/{id}`        | 更新角色                    |
|  4   | DELETE | `/api/system/role/{id}`        | 删除角色                    |
|  5   | POST   | `/api/system/role/assign_menu` | 分配菜单权限 ⬅️ 依赖Menu模块 |
|  6   | GET    | `/api/system/role/{id}/menus`  | 获取角色菜单权限            |

#### P3: Org 模块（6 个接口，需补充）

| 序号 | 方法   | 路径                      | 功能         |  状态  |
| :--: | ------ | ------------------------- | ------------ | :----: |
|  1   | GET    | `/api/system/org/list`    | 获取组织列表 | ✅ 已有 |
|  2   | POST   | `/api/system/org`         | 创建组织     |   ❌    |
|  3   | GET    | `/api/system/org/{id}`    | 获取组织详情 |   ❌    |
|  4   | PUT    | `/api/system/org/{id}`    | 更新组织     |   ❌    |
|  5   | DELETE | `/api/system/org/{id}`    | 删除组织     |   ❌    |
|  6   | PUT    | `/api/system/org/current` | 切换当前组织 |   ❌    |
|  7   | GET    | `/api/system/org/my`      | 获取我的组织 |   ❌    |

#### P4: User 模块（4 个接口，需补充）

| 序号 | 方法 | 路径                           | 功能                    |
| :--: | ---- | ------------------------------ | ----------------------- |
|  1   | GET  | `/api/system/user/list`        | 获取用户列表            |
|  2   | GET  | `/api/system/user/{id}`        | 获取用户详情            |
|  3   | GET  | `/api/system/user/{id}/roles`  | 获取用户角色            |
|  4   | POST | `/api/system/user/assign_role` | 分配角色 ⬅️ 依赖Role+Org |

---

### 五、单模块开发流程（每个模块内部）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        单模块开发流程                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ① DTO           ② Repository      ③ Service      ④ Controller     │
│  ─────────────▶  ─────────────▶   ─────────────▶  ─────────────▶   │
│                                                                     │
│  request/        interfaces/       system/         system/          │
│  xxxReq.go       扩展方法(如需)     xxxSvc.go       xxxCtrl.go       │
│                                                                     │
│  response/       system/                                            │
│  xxxResp.go      xxxRepo.go                                         │
│                                                                     │
│                                   ⑤ Router                          │
│                                  ─────────────▶                     │
│                                                                     │
│                                  system/                            │
│                                  xxxRouter.go                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 六、Casbin 权限验证流程

```
请求 ──▶ JWT中间件 ──▶ 权限中间件 ──▶ Controller
              │              │
              ▼              ▼
        解析 UserID    Casbin.Enforce()
        解析 OrgID           │
              │              ▼
              │      subject = "userID@orgID"
              │      resource = "path:method"
              │      action = "access"
              │              │
              │              ▼
              │      检查: User ─▶ Role ─▶ Menu ─▶ API
              │              │
              └──────────────┼──────────────────────▶ 通过/拒绝
```

---

### 七、总结

**开发口诀**：先 API 后 Menu，再 Role 再 User，Org 可并行。

**核心原则**：
1. 被依赖的先开发
2. 每完成一个模块可独立测试
3. 避免循环依赖和前置阻塞
