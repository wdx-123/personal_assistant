---
description: Go项目分层架构与编码规范
globs: 
alwaysApply: true
---

# Go 项目开发规范

1. **分层**：Controller（`internal/controller`）仅接收请求/参数校验→
    调用 Service→组装响应，**禁止**业务逻辑/直连DB；
    Service（`internal/service`）只做业务编排，**禁止**直连DB（必须调 Repository）；
    Repository（`internal/repository`）负责**全部**数据库交互（CRUD/JOIN）。

2. **DTO**：请求/响应分别放 `internal/model/dto/request`、`internal/model/dto/response`，不存在就新建，
    **禁止**直接用 Entity/散装参数。
    统一响应用 `pkg/response`：`NewResponse[T,R](c).Success/Failed`。

3. **错误与日志**：底层遇到无法处理的错误**立刻 return error**；
    Controller **统一捕获**→`global.Log.Error`记录→返回 `Failed`。

4. **Context**：DB操作/长链路调用必须传 `context.Context`。

5. **实现顺序**：DTO → Repository → Service → Controller → Router（`internal/router`）。

6. 路由入口 `router.go` 仅建 Group/挂中间件；
具体业务路由按领域拆到 `internal/router/system`，每个模块提供 `InitXRouter(*gin.RouterGroup)`；入口通过 `GroupApp.System` 统一调用注册。

7. 具体功能初始化优先放在 `internal/core`（显式声明依赖且复用 `global.*` 单例），`internal/init/init.go` 仅按依赖顺序统一编排调用与启动后台任务，禁止重复创建或多处启动同一组件。

8. 新增加代码时，请加上必要的生产级注释。

9. **禁止硬编码**：所有可变参数必须定义在 `internal/model/config` 并由 `configs.yaml` 驱动，业务代码仅通过 `global.Config` 调用，代码内仅保留必要的零值兜底。

10. **业务错误处理**（新功能使用）：
    - **Repository**：只返回原始 `error`，不感知业务场景
    - **Service**：用 `pkg/errors` 包装为 `BizError`（决定错误码+消息）
      - `errors.New(code)` 默认消息
      - `errors.NewWithMsg(code, msg)` 自定义消息
      - `errors.Wrap(code, cause)` 包装原始错误+默认消息
      - `errors.WrapWithMsg(code, msg, cause)` 包装原始错误+自定义消息
    - **Controller**：`global.Log.Error()` 记日志 + `response.BizFailWithError(err, c)` 返回
    - **响应函数**：只负责返回，不耦合日志
    - 错误码：`pkg/errors/codes.go`（1xxxx通用/2xxxx用户/3xxxx组织与权限/4xxxxOJ）

11. **复用 `pkg` 公共能力**：`pkg/` 下已有的工具函数优先复用，禁止在业务层重复实现。
    - **JWT/用户信息**：Controller 中提取当前用户 ID 统一使用 `pkg/jwt.GetUserID(c)`，禁止各模块自行解析 claims。
    - **通用工具**：与业务无关的纯函数（哈希、格式转换、数组操作等）统一放 `pkg/util`，新增前先检查是否已存在。
    - **抽取原则**：当逻辑满足以下任一条件时应从 Service 提取到 `pkg/`：① 不依赖业务上下文（Entity/Repository）；② 可被多个 Service 或非 Service 层复用；③ 属于算法/协议/格式处理等基础能力。
