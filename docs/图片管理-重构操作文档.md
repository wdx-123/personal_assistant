# 图片管理模块 — 重构操作文档

> 基于 `z_image_add`（旧项目成熟实现）+ 本项目已有配置/常量，重构出适配当前分层架构的生产级图片管理模块。

---

## 一、两套代码对比分析

### 旧项目（z_image_add）的优点 — 直接复用

| 组件 | 文件 | 复用价值 |
|------|------|---------|
| 存储驱动接口 | `storage/driver.go` | `Driver` 接口 + `StorageObject` 设计成熟，直接采用 |
| 驱动管理器 | `storage/manager.go` | 多驱动注册/切换/并发安全，核心逻辑保留 |
| 本地驱动 | `storage/local/local.go` | 流式上传 + Key 生成 + 删除幂等，保留核心 |
| 七牛驱动 | `storage/qiniu/qiniu.go` | 分片上传 V2 + 凭证管理 + 删除 612 兼容，保留核心 |
| 重试机制 | `storage/retry.go` | 指数退避 + 抖动 + Context 感知，直接复用 |
| HTTP 客户端 | `storage/httpclient.go` | 共享连接池，直接复用 |
| 上传绑定 | `imageutils/helpers.go` | `ApplyStorageObject` / `UploadAndBind` 思路保留 |
| 图片实体 | `image.go` | Driver/Key/URL/FileHash 字段设计保留 |

### 旧项目的缺点 — 需要改造

| 问题 | 说明 | 改造方案 |
|------|------|---------|
| 全局变量不匹配 | 旧用 `globals.*`，新用 `global.*` | 全部替换 |
| `init()` 注册驱动 | 隐式依赖，违反本项目 `internal/core` 显式初始化原则 | 改为 `core.InitStorage()` 显式调用 |
| imageutils 混合 DB+文件 | 违反分层架构：Repository 管 DB，Service 管编排 | 拆分到 Repository + Service 层 |
| Entity 有旧业务字段 | `SchoolID`/`CityID`/`UserID` 是旧业务 | 移除，改为 `Category`/`UploaderID`/`OrgID` |
| selector.go 用 viper 直读 | 本项目统一用 `global.Config` | 改为读 `global.Config.Storage.Current` |
| ParseImageURL 大量兼容 | 本地路径硬编码 `/images/`，HEAD 请求取 size | 上传时直接拿到 size，去掉运行时 HTTP 探测 |
| 七牛凭证读环境变量名 | `AccessKeyEnv` 间接读取 | 简化为直读 `global.Config.Storage.Qiniu.AccessKey` |

### 本项目已有 — 直接保留

| 组件 | 文件 | 说明 |
|------|------|------|
| 配置结构体 | `config/storage.go`, `upload.go`, `static.go` | 已适配 `configs.yaml`，保留 |
| 常量 | `consts/image_category.go`, `image_storage.go` | 保留 |
| 配置初始化 | `config/config.go` + `core/config.go` | 已绑定环境变量，保留 |
| 静态文件挂载 | `router/router.go` 的 `mountStatic()` | 本地驱动仍需要，保留 |
| YAML 配置 | `configs.yaml` 的 storage/static/upload 段 | 已配好七牛域名，保留 |

---

## 二、重构后的目标架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          图片管理模块架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  pkg/storage/                          （存储驱动层 — 纯基础设施）        │
│  ├── driver.go                         Driver 接口 + StorageObject      │
│  ├── manager.go                        多驱动注册/切换/并发安全管理器     │
│  ├── retry.go                          指数退避重试                      │
│  ├── httpclient.go                     共享 HTTP 连接池                  │
│  ├── local/local.go                    本地存储驱动                      │
│  └── qiniu/qiniu.go                    七牛云存储驱动                    │
│                                                                         │
│  internal/model/                                                        │
│  ├── entity/image.go                   Image 实体（数据库模型）          │
│  ├── dto/request/imageReq.go           上传/查询/删除请求 DTO            │
│  └── dto/response/imageResp.go         图片响应 DTO                     │
│                                                                         │
│  internal/repository/                                                   │
│  ├── interfaces/imageRepository.go     图片仓储接口                     │
│  └── system/imageRepo.go              图片仓储实现（纯 DB 操作）         │
│                                                                         │
│  internal/service/system/                                               │
│  └── imageSvc.go                       图片业务服务（编排：驱动+仓储）   │
│                                                                         │
│  internal/controller/system/                                            │
│  └── imageCtrl.go                      图片控制器（参数校验+响应）       │
│                                                                         │
│  internal/router/system/                                                │
│  └── imageRouter.go                    图片路由注册                     │
│                                                                         │
│  internal/core/                                                         │
│  └── storage.go                        存储驱动初始化入口               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、实现顺序与文件清单

按项目规范：**Storage Driver → Entity → DTO → Repository → Service → Controller → Router**

### 第 1 步：存储驱动层（pkg/storage/）

> 源自 z_image_add/storage，适配本项目 global.Config

| 操作 | 文件 | 来源 | 改造要点 |
|------|------|------|---------|
| **新建** | `pkg/storage/driver.go` | 旧 `storage/driver.go` | 原样复用，无需改动 |
| **新建** | `pkg/storage/manager.go` | 旧 `storage/manager.go` | 移除 `init()` 注册，改为 `Register()` 方法供 core 调用 |
| **新建** | `pkg/storage/retry.go` | 旧 `storage/retry.go` | 原样复用 |
| **新建** | `pkg/storage/httpclient.go` | 旧 `storage/httpclient.go` | 原样复用 |
| **新建** | `pkg/storage/local/local.go` | 旧 `storage/local/local.go` | `globals.*` → `global.*`；配置路径改为 `global.Config.Static.Path`；移除 `init()` |
| **新建** | `pkg/storage/qiniu/qiniu.go` | 旧 `storage/qiniu/qiniu.go` | `globals.*` → `global.*`；凭证直读 `global.Config.Storage.Qiniu`；移除 `init()`；移除 `AccessKeyEnv` 间接读取 |

**关键改造：驱动初始化**

旧代码用 `init()` 自动注册 → 本项目改为在 `internal/core/storage.go` 显式初始化：

```go
// internal/core/storage.go
package core

import (
    "personal_assistant/global"
    "personal_assistant/pkg/storage"
    "personal_assistant/pkg/storage/local"
    "personal_assistant/pkg/storage/qiniu"
)

// InitStorage 初始化存储驱动（在 DB 之后、Server 之前调用）
func InitStorage() {
    storage.RegisterDriver("local", local.New())
    storage.RegisterDriver("qiniu", qiniu.New())
    storage.InitAll()
    if current := global.Config.Storage.Current; current != "" {
        storage.SetCurrent(current)
    }
}
```

在 `internal/init/init.go` 中添加调用（位于 Redis 初始化之后）：
```go
// 初始化存储驱动
core.InitStorage()
```

### 第 2 步：图片实体（internal/model/entity/image.go）

> 源自 z_image_add/image.go，适配本项目 MODEL 基类

```go
// internal/model/entity/image.go
type Image struct {
    MODEL

    // ===== 文件基础信息 =====
    Name string `json:"name" gorm:"type:varchar(255);not null;comment:'原始文件名'"`
    Type string `json:"type" gorm:"type:varchar(32);not null;comment:'文件扩展名(如 .png)'"`
    Size int64  `json:"size" gorm:"not null;default:0;comment:'文件大小(字节)'"`

    // ===== 存储定位 =====
    Driver string `json:"driver" gorm:"type:varchar(16);not null;default:'local';comment:'存储驱动(local/qiniu)'"`
    Key    string `json:"key" gorm:"type:varchar(512);not null;comment:'存储键(驱动内相对路径)'"`
    URL    string `json:"url" gorm:"type:varchar(1024);not null;comment:'可访问完整URL'"`

    // ===== 业务归属 =====
    Category   consts.Category `json:"category" gorm:"type:tinyint;not null;default:0;index;comment:'图片分类'"`
    UploaderID uint            `json:"uploader_id" gorm:"index;comment:'上传者用户ID'"`
    OrgID      *uint           `json:"org_id,omitempty" gorm:"index;comment:'所属组织ID'"`

    // ===== 去重与校验 =====
    FileHash string `json:"file_hash,omitempty" gorm:"type:varchar(32);index:idx_images_file_hash;comment:'文件MD5哈希'"`
    HashAlgo string `json:"hash_algo,omitempty" gorm:"type:varchar(16);default:'md5';comment:'哈希算法'"`
}
```

**对比旧 Entity 的改动：**
- `gorm.Model` → `entity.MODEL`（本项目基类）
- 移除 `Path`（旧兼容字段，新项目不需要）
- 移除 `SchoolID`/`CityID`/`UserID` → 改为 `Category`/`UploaderID`/`OrgID`
- 保留 `Driver`/`Key`/`URL`/`FileHash`/`HashAlgo`

### 第 3 步：DTO 定义

**请求 DTO**（`internal/model/dto/request/imageReq.go`）：

```go
// UploadImageReq 图片上传请求（multipart/form-data，非 JSON body）
type UploadImageReq struct {
    Category consts.Category `form:"category"`  // 图片分类（可选）
}

// DeleteImageReq 删除图片请求
type DeleteImageReq struct {
    IDs []uint `json:"ids" binding:"required,min=1"` // 要删除的图片 ID 列表
}

// ListImageReq 图片列表查询请求
type ListImageReq struct {
    Page     int             `form:"page" binding:"omitempty,min=1"`
    PageSize int             `form:"page_size" binding:"omitempty,min=1,max=100"`
    Category consts.Category `form:"category" binding:"omitempty"`
}
```

**响应 DTO**（`internal/model/dto/response/imageResp.go`）：

```go
// ImageItem 单张图片信息
type ImageItem struct {
    ID       uint   `json:"id"`
    URL      string `json:"url"`
    Name     string `json:"name"`
    Type     string `json:"type"`
    Size     int64  `json:"size"`
    Category string `json:"category"`
}

// UploadImageResp 上传成功响应
type UploadImageResp struct {
    Images []ImageItem `json:"images"`
}
```

### 第 4 步：Repository 层（纯 DB）

**接口**（`internal/repository/interfaces/imageRepository.go`）：

```go
type ImageRepository interface {
    Create(ctx context.Context, image *entity.Image) error
    BatchCreate(ctx context.Context, images []*entity.Image) error
    GetByID(ctx context.Context, id uint) (*entity.Image, error)
    GetByIDs(ctx context.Context, ids []uint) ([]entity.Image, error)
    Delete(ctx context.Context, ids []uint) error
    List(ctx context.Context, category consts.Category, offset, limit int) ([]entity.Image, int64, error)
    CountByKey(ctx context.Context, key string) (int64, error)
    GetByFileHash(ctx context.Context, hash string, size int64) (*entity.Image, error)
}
```

**实现**（`internal/repository/system/imageRepo.go`）：
- 纯 GORM 操作，不涉及文件系统
- `Delete` 仅软删除数据库记录
- `CountByKey` 用于判断文件是否被其他记录引用（删除前检查）
- `GetByFileHash` 用于秒传去重

### 第 5 步：Service 层（业务编排）

**文件**：`internal/service/system/imageSvc.go`

核心方法：

```go
type ImageSvc interface {
    // Upload 上传图片：校验 → 驱动上传 → 入库
    Upload(ctx context.Context, files []*multipart.FileHeader, category consts.Category, uploaderID uint, orgID *uint) ([]response.ImageItem, error)

    // Delete 删除图片：查库 → 检查引用 → 驱动删除文件 → 删库
    Delete(ctx context.Context, ids []uint) error

    // List 图片列表：分页查询
    List(ctx context.Context, req request.ListImageReq) ([]response.ImageItem, int64, error)

    // GetURL 获取图片URL（优先 URL 字段）
    GetURL(ctx context.Context, id uint) (string, error)
}
```

**Upload 流程（核心改造点）**：

```
1. 校验文件类型/大小（对比 global.Config.Static.AllowedTypes/MaxSize）
2. 计算 FileHash（MD5），查库是否已存在（秒传）
3. 调用 storage.CurrentDriver().Upload(ctx, reader, filename)
4. 用返回的 StorageObject 构建 entity.Image
5. 入库并返回响应
```

**Delete 流程**：
```
1. 查库拿到 Image 列表
2. 对每个 Image.Key：CountByKey 检查是否有其他记录引用
3. 如果无其他引用 → storage.DriverFromName(img.Driver).Delete(ctx, key)
4. 软删除数据库记录
```

**对比旧 imageutils 的改进**：
- 不再 HTTP HEAD 探测文件大小（上传时直接拿到）
- 不再自调 HTTP 删除（直接走驱动）
- 不再硬编码 `/images/` 路径
- 新增秒传（FileHash 去重）

### 第 6 步：Controller 层

**文件**：`internal/controller/system/imageCtrl.go`

```go
// Upload 上传图片 — POST /image/upload (multipart/form-data)
func (ctrl *ImageCtrl) Upload(c *gin.Context) {
    // 1. 解析 multipart 表单
    // 2. 从 JWT 中提取 uploaderID / orgID
    // 3. 调用 imageSvc.Upload()
    // 4. global.Log.Error 记日志 + response.BizFailWithError 返回错误
    // 5. response.NewResponse[T,R](c).Success(data) 返回成功
}

// Delete 删除图片 — DELETE /image/delete
// List   图片列表 — GET /image/list
```

### 第 7 步：Router 层

**文件**：`internal/router/system/imageRouter.go`

```go
func InitImageRouter(group *gin.RouterGroup) {
    imageGroup := group.Group("image")
    {
        imageGroup.POST("/upload", controller.ApiGroupApp.SystemApiGroup.GetImageCtrl().Upload)
        imageGroup.DELETE("/delete", controller.ApiGroupApp.SystemApiGroup.GetImageCtrl().Delete)
        imageGroup.GET("/list", controller.ApiGroupApp.SystemApiGroup.GetImageCtrl().List)
    }
}
```

在 `internal/router/system/enter.go` 中注册调用。

---

## 四、依赖变更

### 需要新增的 Go 依赖

```bash
go get github.com/qiniu/go-sdk/v7
```

（旧项目已使用 `github.com/qiniu/go-sdk/v7`，本项目 go.mod 中尚未添加）

### AutoMigrate 注册

在 `flag/sql.go`（或数据库迁移文件）中添加 `&entity.Image{}`。

---

## 五、configs.yaml 无需改动

当前配置已完备：

```yaml
storage:
  current: "qiniu"                              # ✅ 已配
  qiniu:
    domain: "http://img.metaassist.cn"           # ✅ 已改为自有域名
    bucket: "wdx89"                              # ✅ 已配
    access_key / secret_key                      # ✅ 已支持环境变量覆盖
static:
  path: "./static/images"                        # ✅ 本地驱动使用
  prefix: "/images"                              # ✅ 静态文件挂载
  max_size: 16                                   # ✅ 文件大小限制
  allowed_types: [".png", ".jpeg", ".gif", ".jpg", ".bin"]  # ✅ 类型白名单
```

---

## 六、旧代码（z_image_add）各文件处置清单

| 旧文件 | 处置 | 说明 |
|--------|------|------|
| `storage/driver.go` | **复制** → `pkg/storage/driver.go` | 原样复用 |
| `storage/manager.go` | **复制+改造** → `pkg/storage/manager.go` | 移除全局 `var manager`，改为可注入式 |
| `storage/retry.go` | **复制** → `pkg/storage/retry.go` | 原样复用 |
| `storage/httpclient.go` | **复制** → `pkg/storage/httpclient.go` | 原样复用 |
| `storage/selector.go` | **不复制** | 功能合并到 `core/storage.go` |
| `storage/local/local.go` | **复制+改造** → `pkg/storage/local/local.go` | 全局变量替换 + 移除 init() |
| `storage/qiniu/qiniu.go` | **复制+改造** → `pkg/storage/qiniu/qiniu.go` | 全局变量替换 + 凭证简化 + 移除 init() |
| `image.go` | **不复制** | 字段设计参考，但重新建模适配本项目 |
| `imageutils/imageUtil.go` | **不复制** | DB 操作拆到 Repository，业务拆到 Service |
| `imageutils/helpers.go` | **部分复用** | `ApplyStorageObject` 思路融入 Service 层 |

---

## 七、执行步骤检查清单

```
Phase 1 — 存储驱动层
  [ ] 1.1  新建 pkg/storage/driver.go（接口 + StorageObject）
  [ ] 1.2  新建 pkg/storage/manager.go（驱动管理器）
  [ ] 1.3  新建 pkg/storage/retry.go（重试机制）
  [ ] 1.4  新建 pkg/storage/httpclient.go（共享 HTTP 客户端）
  [ ] 1.5  新建 pkg/storage/local/local.go（本地驱动）
  [ ] 1.6  新建 pkg/storage/qiniu/qiniu.go（七牛驱动）
  [ ] 1.7  go get github.com/qiniu/go-sdk/v7
  [ ] 1.8  新建 internal/core/storage.go（驱动初始化入口）
  [ ] 1.9  修改 internal/init/init.go 添加 core.InitStorage() 调用

Phase 2 — 数据模型层
  [ ] 2.1  新建 internal/model/entity/image.go
  [ ] 2.2  在 AutoMigrate 中注册 &entity.Image{}
  [ ] 2.3  新建 internal/model/dto/request/imageReq.go
  [ ] 2.4  新建 internal/model/dto/response/imageResp.go

Phase 3 — Repository 层
  [ ] 3.1  新建 internal/repository/interfaces/imageRepository.go
  [ ] 3.2  新建 internal/repository/system/imageRepo.go
  [ ] 3.3  在 repository supplier 中注册 ImageRepository

Phase 4 — Service 层
  [ ] 4.1  新建 internal/service/system/imageSvc.go（接口 + 实现）
  [ ] 4.2  在 service supplier 中注册 ImageSvc

Phase 5 — Controller + Router 层
  [ ] 5.1  新建 internal/controller/system/imageCtrl.go
  [ ] 5.2  在 controller supplier 中注册 ImageCtrl
  [ ] 5.3  新建 internal/router/system/imageRouter.go
  [ ] 5.4  在 router/system/enter.go 中调用 InitImageRouter

Phase 6 — 验证与清理
  [ ] 6.1  编译通过
  [ ] 6.2  启动后 AutoMigrate 创建 images 表
  [ ] 6.3  POST /image/upload 测试上传到七牛
  [ ] 6.4  GET /image/list 测试查询
  [ ] 6.5  DELETE /image/delete 测试删除（DB + 七牛文件）
  [ ] 6.6  确认 nslookup img.metaassist.cn 正常
  [ ] 6.7  确认图片 URL 可通过 CDN 访问
  [ ] 6.8  可选：删除 z_image_add 目录
  [ ] 6.9  可选：更新 docs/ 下的旧文档
```

---

## 八、关键设计决策总结

| 决策 | 选择 | 理由 |
|------|------|------|
| 驱动初始化方式 | 显式 `core.InitStorage()` | 本项目禁止 `init()` 隐式依赖 |
| 实体基类 | `entity.MODEL` | 本项目统一基类 |
| 移除 `Path` 字段 | 只保留 `Key` + `URL` | 新项目无历史包袱，`Path` 是旧项目的兼容产物 |
| 删除策略 | 引用计数检查 + 驱动删除 | 源自旧项目 `removeOldImageIfUnused`，防误删 |
| 秒传 | FileHash + Size 预检 | 源自旧项目 `file_hash` 设计，减少重复上传 |
| 错误处理 | Service 用 `pkg/errors` 包装 BizError | 本项目规范 |
| 配置读取 | 统一 `global.Config.*` | 本项目规范，不直接读 viper |
