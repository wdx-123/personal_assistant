# Casbin + RBAC æƒé™ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ **Casbin + RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰** æ¨¡å¼å®ç°æƒé™ç®¡ç†ç³»ç»Ÿã€‚Casbin ä½œä¸ºæƒé™æ‰§è¡Œå¼•æ“ï¼ŒRBAC ä½œä¸ºæƒé™æ¨¡å‹ï¼Œä¸¤è€…ç»“åˆæä¾›äº†çµæ´»ã€é«˜æ•ˆçš„æƒé™æ§åˆ¶æ–¹æ¡ˆã€‚

## 2. æ ¸å¿ƒç»„ä»¶æ¶æ„

### 2.1 æƒé™æ¨¡å‹å®šä¹‰ (model.conf)

```ini
[request_definition]
r = sub, obj

[policy_definition]  
p = sub, obj

[role_definition]
g = _,_

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && r.obj == p.obj
```

**è§£é‡Šï¼š**
- `sub`: ä¸»ä½“ï¼ˆç”¨æˆ·IDæˆ–è§’è‰²ä»£ç ï¼‰
- `obj`: å¯¹è±¡ï¼ˆèµ„æºï¼Œå¦‚APIè·¯å¾„æˆ–èœå•ä»£ç ï¼‰
- `g`: è§’è‰²ç»§æ‰¿å…³ç³»ï¼ˆç”¨æˆ· â†’ è§’è‰²ï¼‰
- `p`: æƒé™ç­–ç•¥ï¼ˆè§’è‰² â†’ èµ„æºï¼‰

### 2.2 æ•°æ®åº“è¡¨ç»“æ„

```
ç”¨æˆ·è¡¨ (users)
â”œâ”€â”€ id (ç”¨æˆ·ID)
â”œâ”€â”€ username
â”œâ”€â”€ email
â””â”€â”€ ... (æ³¨æ„ï¼šä¸åŒ…å«role_idå­—æ®µ)

è§’è‰²è¡¨ (roles)  
â”œâ”€â”€ id (è§’è‰²ID)
â”œâ”€â”€ code (è§’è‰²ä»£ç ï¼Œå¦‚ "admin", "user")
â”œâ”€â”€ name (è§’è‰²åç§°)
â””â”€â”€ ...

èœå•è¡¨ (menus)
â”œâ”€â”€ id (èœå•ID) 
â”œâ”€â”€ code (èœå•ä»£ç )
â”œâ”€â”€ name (èœå•åç§°)
â””â”€â”€ ...

APIè¡¨ (apis)
â”œâ”€â”€ id (API ID)
â”œâ”€â”€ path (APIè·¯å¾„)
â”œâ”€â”€ method (HTTPæ–¹æ³•)
â””â”€â”€ ...

å…³ç³»è¡¨ï¼ˆæ ¸å¿ƒï¼‰ï¼š
â”œâ”€â”€ user_org_roles (ç”¨æˆ·-ç»„ç»‡-è§’è‰²å…³ç³») â† å¤šç§Ÿæˆ·æ ¸å¿ƒå…³ç³»è¡¨
â”œâ”€â”€ role_menus (è§’è‰²-èœå•å…³ç³»)  
â””â”€â”€ menu_apis (èœå•-APIå…³ç³»)
```

## 3. æƒé™æ§åˆ¶é€»è¾‘å…³ç³»

### 3.1 ä¸‰å±‚æƒé™æ¨¡å‹

```
ç”¨æˆ· (User) â†’ è§’è‰² (Role) â†’ èœå• (Menu) â†’ API
     â†“           â†“           â†“         â†“
   userID    roleCode    menuCode   path:method
```

**æƒé™ä¼ é€’é“¾ï¼š**
1. **ç”¨æˆ· â†’ è§’è‰²**ï¼šç”¨æˆ·æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²
2. **è§’è‰² â†’ èœå•**ï¼šè§’è‰²å¯ä»¥è®¿é—®ç‰¹å®šçš„å‰ç«¯èœå•é¡µé¢
3. **èœå• â†’ API**ï¼šèœå•å…³è”åç«¯APIæ¥å£

### 3.2 Casbin ç­–ç•¥å­˜å‚¨

Casbin å°†æƒé™å…³ç³»å­˜å‚¨ä¸ºç­–ç•¥è§„åˆ™ï¼š

```
# ç”¨æˆ·è§’è‰²å…³ç³» (gç­–ç•¥)
g, 1@1, admin        # ç”¨æˆ·1åœ¨ç»„ç»‡1æ‹¥æœ‰adminè§’è‰²
g, 1@2, user         # ç”¨æˆ·1åœ¨ç»„ç»‡2æ‹¥æœ‰userè§’è‰²

# è§’è‰²èœå•æƒé™ (pç­–ç•¥)  
p, admin, user_manage, read    # adminè§’è‰²å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†èœå•
p, user, dashboard, read       # userè§’è‰²å¯ä»¥è®¿é—®ä»ªè¡¨æ¿èœå•

# èœå•APIæƒé™ (pç­–ç•¥)
p, user_manage, /api/users:GET, access     # ç”¨æˆ·ç®¡ç†èœå•å¯ä»¥è°ƒç”¨ç”¨æˆ·åˆ—è¡¨API
p, dashboard, /api/stats:GET, access       # ä»ªè¡¨æ¿èœå•å¯ä»¥è°ƒç”¨ç»Ÿè®¡API
```

## 4. æƒé™éªŒè¯æµç¨‹

### 4.1 APIæƒé™éªŒè¯ä¸­é—´ä»¶

```go
// æƒé™éªŒè¯æµç¨‹
func (p *PermissionMiddleware) CheckPermission() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. æ£€æŸ¥ç™½åå•ï¼ˆç™»å½•ã€æ³¨å†Œç­‰å…¬å¼€æ¥å£ï¼‰
        if isWhiteList(path, method) {
            c.Next()
            return
        }
        
        // 2. æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»JWT Tokenï¼‰
        userID := extractUserID(c)
        
        // 3. æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜ï¼ˆç›´æ¥æ”¾è¡Œï¼‰
        if isSuperAdmin(userID) {
            c.Next() 
            return
        }
        
        // 4. éªŒè¯APIæƒé™
        resource := fmt.Sprintf("%s:%s", path, method)
        hasPermission := casbin.Enforce(userID, resource, "access")
        
        if !hasPermission {
            c.Abort()
            return
        }
        
        c.Next()
    }
}
```

### 4.2 æƒé™éªŒè¯é€»è¾‘

```
è¯·æ±‚ /api/users (GET) 
    â†“
1. ç”¨æˆ·ID: "1"ï¼Œå½“å‰ç»„ç»‡ID: "1"
    â†“  
2. CasbinæŸ¥è¯¢: Enforce("1@1", "/api/users:GET", "access")
    â†“
3. Casbinå†…éƒ¨æ¨ç†:
   - ç”¨æˆ·1åœ¨ç»„ç»‡1æœ‰adminè§’è‰²: g("1@1", "admin") âœ“
   - adminè§’è‰²æœ‰user_manageèœå•æƒé™: p("admin", "user_manage", "read") âœ“  
   - user_manageèœå•æœ‰/api/users:GETæƒé™: p("user_manage", "/api/users:GET", "access") âœ“
    â†“
4. è¿”å›: true (å…è®¸è®¿é—®)
```

## 5. ç”¨æˆ·æ³¨å†Œä¸é»˜è®¤è§’è‰²åˆ†é…

### 5.1 æ³¨å†Œæµç¨‹

```go
func (u *UserService) Register(ctx *gin.Context, req *request.RegisterReq) (*entity.User, error) {
    // 1. éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼ˆé‚®ç®±ã€ç”¨æˆ·åå”¯ä¸€æ€§ï¼‰
    
    // 2. åˆ›å»ºç”¨æˆ·è®°å½•
    user := &entity.User{
        Username: req.Username,
        Password: util.BcryptHash(req.Password),
        Email:    req.Email,
        UUID:     uuid.Must(uuid.NewV4()),
        // æ³¨æ„ï¼šç”¨æˆ·è¡¨ä¸åŒ…å«role_idå­—æ®µï¼Œè§’è‰²é€šè¿‡å…³ç³»è¡¨ç®¡ç†
    }
    err = u.userRepo.Create(ctx, user)
    
    // 3. åˆ†é…é»˜è®¤è§’è‰²ï¼ˆä»é…ç½®è·å–ï¼‰
    defaultRoleCode := global.Config.System.DefaultRoleCode
    if defaultRoleCode == "" {
        defaultRoleCode = "user" // å…œåº•é»˜è®¤å€¼
    }
    
    // 4. æŸ¥æ‰¾é»˜è®¤è§’è‰²
    defaultRole, err := u.roleRepo.GetByCode(ctx, defaultRoleCode)
    
    // 5. é€šè¿‡æƒé™æœåŠ¡åˆ†é…è§’è‰²ï¼ˆåŒæ—¶æ›´æ–°æ•°æ®åº“å’ŒCasbinï¼‰
    err = u.permissionService.AssignRoleToUserInOrg(ctx, user.ID, req.OrgID, defaultRole.ID)
    
    return user, nil
}
```

### 5.2 è§’è‰²åˆ†é…çš„åŒé‡æ“ä½œ

```go
func (p *PermissionService) AssignRoleToUserInOrg(ctx context.Context, userID, orgID, roleID uint) error {
    // è·å–è§’è‰²ä¿¡æ¯
    role, err := roleRepo.GetByID(ctx, roleID)
    
    // 1. æ•°æ®åº“æ“ä½œï¼šåœ¨user_org_rolesè¡¨ä¸­æ’å…¥å…³ç³»è®°å½•
    err = roleRepo.AssignRoleToUserInOrg(ctx, userID, orgID, roleID)
    
    // 2. Casbinæ“ä½œï¼šæ·»åŠ ç”¨æˆ·è§’è‰²å…³ç³»åˆ°å†…å­˜ç­–ç•¥
    subject := fmt.Sprintf("%d@%d", userID, orgID)
    _, err = p.casbinSvc.Enforcer.AddRoleForUser(subject, role.Code)
    
    // å¦‚æœCasbinæ“ä½œå¤±è´¥ï¼Œå›æ»šæ•°æ®åº“æ“ä½œï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
    if err != nil {
        roleRepo.RemoveRoleFromUserInOrg(ctx, userID, orgID, roleID)
        return err
    }
    
    return nil
}
```

## 6. æƒé™åŒæ­¥æœºåˆ¶

### 6.1 ç³»ç»Ÿå¯åŠ¨æ—¶çš„æƒé™åŒæ­¥

```go
func (p *PermissionService) SyncAllPermissionsToCasbin(ctx context.Context) error {
    // 1. æ¸…ç©ºç°æœ‰æƒé™
    p.ClearAllPermission(ctx)
    
    // 2. åŒæ­¥ç”¨æˆ·è§’è‰²å…³ç³»
    p.SyncUserRolesToCasbin(ctx)
    
    // 3. åŒæ­¥è§’è‰²èœå•æƒé™  
    p.SyncRoleMenusToCasbin(ctx)
    
    // 4. åŒæ­¥èœå•APIæƒé™
    p.SyncMenuAPIsToCasbin(ctx)
    
    return nil
}
```

### 6.2 æ•°æ®ä¸€è‡´æ€§ä¿è¯

- **åŒå†™ç­–ç•¥**ï¼šæ¯æ¬¡æƒé™å˜æ›´åŒæ—¶æ›´æ–°æ•°æ®åº“å’ŒCasbin
- **äº‹åŠ¡å›æ»š**ï¼šCasbinæ“ä½œå¤±è´¥æ—¶å›æ»šæ•°æ®åº“æ“ä½œ
- **å®šæœŸåŒæ­¥**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶ä»æ•°æ®åº“é‡æ–°åŒæ­¥æ‰€æœ‰æƒé™åˆ°Casbin

## 7. é…ç½®åŒ–é»˜è®¤è§’è‰²

### 7.1 é…ç½®æ–‡ä»¶ (configs.yaml)

```yaml
system:
  host: "0.0.0.0"
  port: 8080
  env: "debug"
  default_role_code: "user"        # é»˜è®¤è§’è‰²ä»£ç 
  default_role_name: "æ™®é€šç”¨æˆ·"     # é»˜è®¤è§’è‰²åç§°
```

### 7.2 é…ç½®ç»“æ„ä½“

```go
type System struct {
    Host            string `yaml:"host"`
    Port            int    `yaml:"port"`
    Env             string `yaml:"env"`
    DefaultRoleCode string `yaml:"default_role_code"` // æ–°ç”¨æˆ·é»˜è®¤è§’è‰²
    DefaultRoleName string `yaml:"default_role_name"` // é»˜è®¤è§’è‰²æ˜¾ç¤ºå
}
```

## 8. å…³é”®ç‰¹æ€§

### 8.1 ä¼˜åŠ¿

1. **çµæ´»æ€§**ï¼šæ”¯æŒå¤æ‚çš„æƒé™æ¨¡å‹å’ŒåŠ¨æ€æƒé™å˜æ›´
2. **æ€§èƒ½**ï¼šCasbinå†…å­˜æ‰§è¡Œï¼Œæƒé™éªŒè¯é«˜æ•ˆ
3. **ä¸€è‡´æ€§**ï¼šæ•°æ®åº“ä¸CasbinåŒé‡ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **å¯é…ç½®**ï¼šé»˜è®¤è§’è‰²å¯é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»è°ƒæ•´
5. **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§æƒé™æ¨¡å‹ï¼ˆRBACã€ABACç­‰ï¼‰

### 8.2 å®‰å…¨ä¿éšœ

1. **ç™½åå•æœºåˆ¶**ï¼šå…¬å¼€æ¥å£æ— éœ€æƒé™éªŒè¯
2. **è¶…çº§ç®¡ç†å‘˜**ï¼šç‰¹æ®Šè§’è‰²æ‹¥æœ‰æ‰€æœ‰æƒé™
3. **æƒé™ä¼ é€’**ï¼šé€šè¿‡è§’è‰²ç»§æ‰¿å®ç°æƒé™ä¼ é€’
4. **äº‹åŠ¡ä¿è¯**ï¼šæƒé™å˜æ›´çš„åŸå­æ€§æ“ä½œ

## 9. ä½¿ç”¨ç¤ºä¾‹

### 9.1 æ–°ç”¨æˆ·æ³¨å†Œ

```
1. ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯
2. ç³»ç»Ÿåˆ›å»ºç”¨æˆ·è®°å½•
3. ä»é…ç½®è·å–é»˜è®¤è§’è‰² "user"
4. åˆ†é…è§’è‰²ï¼š
   - æ•°æ®åº“ï¼šINSERT INTO user_roles (user_id, role_id) VALUES (1, 2)
   - Casbinï¼šAddRoleForUser("1", "user")
5. ç”¨æˆ·è·å¾—é»˜è®¤æƒé™ï¼Œå¯ä»¥è®¿é—®æ™®é€šç”¨æˆ·èœå•å’ŒAPI
```

### 9.2 æƒé™éªŒè¯

```
1. ç”¨æˆ·è®¿é—® /api/users
2. ä¸­é—´ä»¶æå–ç”¨æˆ·ID: "1"  
3. CasbinéªŒè¯ï¼šEnforce("1", "/api/users:GET", "access")
4. å†…éƒ¨æ¨ç†ï¼šç”¨æˆ·1 â†’ userè§’è‰² â†’ dashboardèœå• â†’ /api/users:GET
5. è¿”å›éªŒè¯ç»“æœ
```

## 10. æ€»ç»“

æœ¬æƒé™ç³»ç»Ÿé€šè¿‡ **Casbin + RBAC** çš„ç»„åˆï¼Œå®ç°äº†ï¼š

- **åˆ†å±‚æƒé™æ§åˆ¶**ï¼šç”¨æˆ· â†’ è§’è‰² â†’ èœå• â†’ API çš„å››å±‚æƒé™æ¨¡å‹
- **é…ç½®åŒ–ç®¡ç†**ï¼šé»˜è®¤è§’è‰²å¯é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»è°ƒæ•´
- **æ•°æ®ä¸€è‡´æ€§**ï¼šæ•°æ®åº“ä¸Casbinçš„åŒé‡åŒæ­¥æœºåˆ¶
- **é«˜æ€§èƒ½éªŒè¯**ï¼šå†…å­˜çº§åˆ«çš„æƒé™éªŒè¯æ‰§è¡Œ
- **å®‰å…¨å¯é **ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œäº‹åŠ¡å›æ»šæœºåˆ¶

è¿™ç§æ¶æ„æ—¢ä¿è¯äº†æƒé™æ§åˆ¶çš„çµæ´»æ€§å’Œæ€§èƒ½ï¼Œåˆç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚


**ç‰ˆæœ¬**: v0.5
**æœ€åæ›´æ–°**: 2025-10-26 
**ç»´æŠ¤è€…**: ç‹å¾—è´¤

# åæœŸéœ€è¦å‡çº§çš„åœ°æ–¹
æ— æ³•æ§åˆ¶å‰ç«¯çš„ç•Œé¢/æŒ‰é’®å±•ç¤º

ä¸éº»çƒ¦çš„ï¼æ”¹åŠ¨å…¶å®ä¸å¤§ï¼Œè€Œä¸”æˆ‘å·²ç»ä¸ºä½ åˆ†æå¥½äº†å…·ä½“çš„å®ç°æ–¹æ¡ˆã€‚

## ğŸ“Š æ”¹åŠ¨è¯„ä¼°

### ğŸŸ¢ **æ”¹åŠ¨é‡ï¼šå°åˆ°ä¸­ç­‰**
- **æ–°å¢æ–‡ä»¶**ï¼š1-2ä¸ªï¼ˆæŒ‰é’®æƒé™å®ä½“ã€å‰ç«¯æƒé™APIæ§åˆ¶å™¨ï¼‰
- **ä¿®æ”¹æ–‡ä»¶**ï¼š3-4ä¸ªï¼ˆèœå•å®ä½“æ‰©å±•ã€æƒé™æœåŠ¡ã€Repositoryå±‚ï¼‰
- **æ•°æ®åº“å˜æ›´**ï¼š1ä¸ªæ–°è¡¨ + 1ä¸ªå­—æ®µæ‰©å±•

### ğŸš€ **å®ç°éš¾åº¦ï¼šç®€å•**
å› ä¸ºä½ çš„é¡¹ç›®æ¶æ„å·²ç»å¾ˆå®Œå–„äº†ï¼š
1. **RBACåŸºç¡€**ï¼šCasbin + ç”¨æˆ·è§’è‰²ç³»ç»Ÿå·²ç»å®Œæ•´
2. **åˆ†å±‚æ¶æ„**ï¼šRepository-Service-Controller å±‚æ¬¡æ¸…æ™°
3. **æƒé™æ¡†æ¶**ï¼šèœå•æƒé™æŸ¥è¯¢é€»è¾‘å·²å­˜åœ¨ï¼Œåªéœ€æ‰©å±•

### ğŸ’¡ **åæœŸå®ç°æ­¥éª¤é¢„è§ˆ**
```
1ï¸âƒ£ æ‰©å±•Menuå®ä½“ (5åˆ†é’Ÿ)
   - æ·»åŠ  ButtonPermissions å­—æ®µ

2ï¸âƒ£ åˆ›å»ºButtonå®ä½“ (10åˆ†é’Ÿ)  
   - æŒ‰é’®æƒé™è¡¨ç»“æ„

3ï¸âƒ£ æ–°å¢APIæ¥å£ (15åˆ†é’Ÿ)
   - GET /api/user/permissions/frontend
   - è¿”å›ç”¨æˆ·çš„èœå•+æŒ‰é’®æƒé™

4ï¸âƒ£ Repositoryå±‚æ‰©å±• (10åˆ†é’Ÿ)
   - æŸ¥è¯¢ç”¨æˆ·æŒ‰é’®æƒé™æ–¹æ³•

5ï¸âƒ£ æµ‹è¯•éªŒè¯ (10åˆ†é’Ÿ)
```

### âœ¨ **ä¼˜åŠ¿**
- **æ¸è¿›å¼**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½
- **å‘åå…¼å®¹**ï¼šç°æœ‰APIç»§ç»­æ­£å¸¸å·¥ä½œ
- **æ¶æ„ä¸€è‡´**ï¼šéµå¾ªä½ ç°æœ‰çš„è®¾è®¡æ¨¡å¼

**æ€»ç»“**ï¼šå¤§æ¦‚1å°æ—¶å·¦å³çš„å·¥ä½œé‡ï¼Œæ”¹åŠ¨ä¸å¤§ï¼Œè€Œä¸”å¯ä»¥åˆ†æ­¥éª¤å®ç°ï¼Œä¸ä¼šå½±å“ç°æœ‰ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ä½ çš„æ¶æ„è®¾è®¡å¾—å¾ˆå¥½ï¼Œä¸ºåæœŸæ‰©å±•ç•™äº†å¾ˆå¥½çš„ç©ºé—´ï¼ ğŸ¯
        
